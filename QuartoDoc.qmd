```{r setup, include=FALSE}


library(DBI)
library(data.table)
library(dplyr)
library(ggplot2)
library(ggspatial)
library(glue)
library(here)
library(ptaxsim)
library(sf)
library(stringr)
library(tidyr)
library(here)
library(ptaxsim)
library(ggplot2)


ptaxsim_db_conn <- DBI::dbConnect(RSQLite::SQLite(), here("./ptaxsim.db"))
setwd("~/ptax-project")
source('ptax_sim_functions.R')
source('maps.R')





# set the house we want and example districts
pin_14 <- "10082020060000"
year = 2021




districts = c('GLENVIEW PARK DISTRICT',
'OAKTON COMMUNITY COLLEGE DISTRICT',
'COMMUNITY HIGH SCHOOL',
'SCHOOL DISTRICT',
'VILLAGE OF SKOKIE LIBRARY FUND',
'VILLAGE OF SKOKIE',
'ROAD AND BRIDGE NILES',
'GENERAL ASSISTANCE NILES',
'TOWN NILES',
'FOREST PRESERVE DISTRICT OF COOK COUNTY',
'CONSOLIDATED ELECTIONS',
'COUNTY OF COOK')


col_names <- c("district", "levy", "base", "rate", "av", "eav", "property_tax")
df <- data.frame(matrix(ncol = 7, nrow = 0))
colnames(df) <- col_names

df <- populate_df(df, districts, year, pin_14)
df <- format_df(df)
```





```{r, echo=FALSE, fig.width=6, fig.height=4}

(p1_1_cook <- ggplot() +
  geom_sf(data = shp_bnd_cook) + 
  geom_sf(data = shp_bnd_chicago) +
  geom_sf(data = shp_bnd_riverside, fill = "#6a3d9a") + 
  theme_void() + 
  theme(plot.caption = element_text(hjust = 0, face = "italic", size = 9)))
```

We zoom in to show the taxing district of the [**Village of Riverside**]{style="color:purple;"} 


Each year, this taxing district sets a [**levy**]{style="color:purple;"} . This is the amount it needs to collect that year in order to provide services. (This was `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(levy)` in 2021.)


Let's zoom in even further. If you are a [**property owner**]{style="color:red;"} in [**Riverside**]{style="color:purple;"} of a home worth [**`r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(av)`**]{style="color:red;"}, your taxable value (EAV) is [**`r df$eav[1]`**]{style="color:red;"}.

---








```{r, echo=FALSE, fig.width=6, fig.height=4, message=FALSE}
(p1_1_riverside_pin <- ggplot() +
  annotation_map_tile("cartolight", zoomin = -1) +
  annotation_scale(location = "br", unit_category = "imperial") +
  geom_sf(
    data = shp_bnd_example_pin,
    fill = "#e41a1c"
  ) +
  geom_sf(
    data = shp_bnd_riverside,
    color = "#9370DB",
    fill = "transparent",
    linewidth = 1
  ) +
  theme_void() + 
   theme(plot.caption = element_text(hjust = 0, face = "italic", size = 9)))
```

The total taxable value of all properties in [**Riverside**]{style="color:purple;"} make up its [**tax base**]{style="color:fuchsia;"} ([**Riverside's**]{style="color:purple;"} tax base is [**`r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(base)`**]{style="color:fuchsia;"} )

To divide the cost of services among all property owners, [**Riverside**]{style="color:purple;"} sets its local tax rate equal to: $\mathrm{{Levy \over Base} = Tax \hspace{0.1cm} rate}$

```{r, echo=FALSE, fig.width=6, fig.height=4, message=FALSE}

(p1_1_riverside_base <- ggplot() +
  annotation_map_tile("cartolight", zoomin = -1) +
  annotation_scale(location = "br", unit_category = "imperial") +
  geom_sf(
    data = shp_bnd_riverside_pins,
    fill = "#9370DB",
    color = "white",
    alpha = 0.75
  ) +
  geom_sf(
    data = shp_bnd_riverside,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_example_pin,
    fill = "#e41a1c"
  ) +
  theme_void() + 
  theme(plot.caption = element_text(hjust = 0, face = "italic", size = 9)))
```

Using real numbers, the tax rate equals: $\mathrm{{5.9M \over 320M} = 1.84%}$

---

## How much of this tax rate do you pay?

This **rate** is then applied to your **property's taxable value**:

The rate and tax amount then appear as a line item on your tax bill:

| District                                          | Levy/Base                     | 2021 Rate          | 2021 Tax               |
|-----------------------|-----------------|-----------------|-----------------|
| [**Village of Riverside**]{style="color:purple;"} | `r df %>% filter(district == "VILLAGE OF RIVERSIDE") %>% select(levy)`/`r df %>% filter(district == "VILLAGE OF RIVERSIDE") %>% select(base)` | `r df %>% filter(district == "VILLAGE OF RIVERSIDE") %>% select(rate)` | `r df %>% filter(district == "VILLAGE OF RIVERSIDE") %>% select(property_tax)` |

But [**Riverside**]{style="color:purple;"} isn't the only local government you must pay taxes to...

```{r, echo=FALSE, fig.width=6, fig.height=4, message=FALSE}

(p1_1_riverside_base <- ggplot() +
  annotation_map_tile("cartolight", zoomin = -1) +
  annotation_scale(location = "br", unit_category = "imperial") +
  geom_sf(
    data = shp_bnd_riverside_pins,
    fill = "#9370DB",
    color = "white",
    alpha = 0.75
  ) +
  geom_sf(
    data = shp_bnd_riverside,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_example_pin,
    fill = "#e41a1c"
  ) +
  theme_void() + 
  theme(plot.caption = element_text(hjust = 0, face = "italic", size = 9)))
```

There's also [**Elementary School District 96**]{style="color:orange;"} , which sets its own **levy** of [**`r df %>% filter(district == "SCHOOL DISTRICT 96") %>% select(levy)`**]{style="color:orange;"}

```{r, echo=FALSE, fig.width=6, fig.height=4, message=FALSE}
(p1_1_elem_dist_levy <- ggplot() +
  annotation_map_tile("cartolight", zoomin = -1) +
  annotation_scale(location = "br", unit_category = "imperial") +
  geom_sf(
    data = shp_bnd_riverside_pins,
    fill = "#9370DB",
    color = "white"
  ) +
  geom_sf(
    data = shp_bnd_riverside,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_elem_dist,
    color = "#FFB347",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_example_pin,
    fill = "#e41a1c"
  ) +
  theme_void() + 
  theme(plot.caption = element_text(hjust = 0, face = "italic", size = 9)))
```

It adds another line item to your tax bill...

| District                                                   | Levy/Base                         | 2021 Rate          | 2021 Tax               |
|-----------------------|-----------------|-----------------|-----------------|
| [**Village of Riverside**]{style="color:purple;"}          | $`r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(levy)`/ $`r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(base)`     | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(rate)` | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(property_tax)` |
| [**Elementary School District 96**]{style="color:orange;"} | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(levy)`/`r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(base)` | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(rate)`             | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(property_tax)`               |

```{r, echo=FALSE, fig.width=6, fig.height=4, message=FALSE}
(p1_1_elem_dist_base <- ggplot() +
  annotation_map_tile("cartolight", zoomin = -1) +
  annotation_scale(location = "br", unit_category = "imperial") +
  geom_sf(
    data = shp_bnd_elem_dist_pins,
    fill = "#FFB347",
    color = "white"
  ) +
  geom_sf(
    data = shp_bnd_riverside_pins,
    fill = "#9370DB",
    color = "white"
  ) +
  geom_sf(
    data = shp_bnd_riverside,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_elem_dist,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_example_pin,
    fill = "#e41a1c"
  ) +
  theme_void() + 
  theme(plot.caption = element_text(hjust = 0, face = "italic", size = 9)))
```
You must also pay [**Riverside Township**]{style="color:green;"}


---


```{r, echo=FALSE, fig.width=6, fig.height=4, message=FALSE}
(p1_1_township_base <- ggplot() +
  annotation_map_tile("cartolight", zoomin = -1) +
  annotation_scale(location = "br", unit_category = "imperial") +
  geom_sf(
    data = shp_bnd_riverside_pins,
    fill = "#9370DB",
    color = "white"
  ) +
  geom_sf(
    data = shp_bnd_elem_dist_pins,
    fill = "#FFB347",
    color = "white"
  ) +
  geom_sf(
    data = shp_bnd_township_pins,
    fill = "#228B22",
    color = "white"
  ) +
  geom_sf(
    data = shp_bnd_riverside,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_elem_dist,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_township,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_example_pin,
    fill = "#e41a1c"
  ) +
  theme_void() + 
  theme(plot.caption = element_text(hjust = 0, face = "italic", size = 9)))
```
| District                                                   | Levy/Base                         | 2021 Rate | 2021 Tax |
|-----------------------|-----------------|-----------------|-----------------|
| [**Village of Riverside**]{style="color:purple;"}          | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(levy)`/ `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(base)`     | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(rate)` | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(property_tax)` |
| [**Elementary School District 96**]{style="color:orange;"} | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(levy)`/`r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(base)` | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(rate)`             | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(property_tax)` 
| [**Riverside Township**]{style="color:green;"}             |`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(levy)`/`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(base)`| `r df %>% filter(district=="TOWN RIVERSIDE") %>% select(rate)`| `r df %>% filter(district=="TOWN RIVERSIDE") %>% select(property_tax)`    |


---


And [**Brookfield High School District 208**]{style="color:blue;"}
```{r, echo=FALSE, fig.width=6, fig.height=4, message=FALSE}
(p1_1_hs_dist_base <- ggplot() +
  annotation_map_tile("cartolight", zoomin = -1) +
  annotation_scale(location = "br", unit_category = "imperial") +
  geom_sf(
    data = shp_bnd_riverside_pins,
    fill = "#9370DB",
    color = "white"
  ) +
  geom_sf(
    data = shp_bnd_elem_dist_pins,
    fill = "#FFB347",
    color = "white"
  ) +
  geom_sf(
    data = shp_bnd_township_pins,
    fill = "#228B22",
    color = "white"
  ) +
  geom_sf(
    data = shp_bnd_hs_dist_pins,
    fill = "#6495ED",
    color = "white"
  ) +
  geom_sf(
    data = shp_bnd_riverside,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_elem_dist,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_township,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_hs_dist,
    color = "transparent",
    fill = "transparent",
    linewidth = 1
  ) +
  geom_sf(
    data = shp_bnd_example_pin,
    fill = "#e41a1c"
  ) +
  coord_sf(clip = "off") +
  theme_void() + 
  theme(plot.caption = element_text(hjust = 0, face = "italic", size = 9)))
```

| District                                                       | Levy/Base                         | 2021 Rate | 2021 Tax |
|-----------------------|----------------|----------------|----------------|
| [**Village of Riverside**]{style="color:purple;"}          | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(levy)`/ `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(base)`     | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(rate)` | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(property_tax)` |
| [**Elementary School District 96**]{style="color:orange;"} | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(levy)`/`r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(base)` | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(rate)`             | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(property_tax)` 
| [**Riverside Township**]{style="color:green;"}             |`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(levy)`/`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(base)`| `r df %>% filter(district=="TOWN RIVERSIDE") %>% select(rate)`| `r df %>% filter(district=="TOWN RIVERSIDE") %>% select(property_tax)`    |
| [**Brookfield High School District 208**]{style="color:blue;"} |`r df %>% filter(district=="RIVERSIDE BROOKFIELD HIGH SCHOOL 208") %>% select(levy)`/`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(base)`      | `r df %>% filter(district=="RIVERSIDE BROOKFIELD HIGH SCHOOL 208") %>% select(rate)`| `r df %>% filter(district=="RIVERSIDE BROOKFIELD HIGH SCHOOL 208") %>% select(property_tax)` |

---



And the [**Des Plaines Valley Mosquito Abatement District**]{style="color:brown;"}
```{r, echo=FALSE, fig.width=6, fig.height=4, message=FALSE}
(p1_1_cc_dist <- ggplot() +
  annotation_map_tile("cartolight", zoomin = -1) +
  annotation_scale(location = "br", unit_category = "imperial") +
  geom_sf(
    data = shp_bnd_cc_dist,
    color = "#e31a1c",
    fill = "#fb9a99",
    linewidth = 0.1,
    alpha = 0.5
  ) +
  geom_sf(
    data = shp_bnd_hs_diff,
    color = "#6495ED",
    fill = "#6495ED",
    linewidth = 0.3,
    alpha = 0.5
  ) +
  geom_sf(
    data = shp_bnd_township_diff,
    color = "#228B22",
    fill = "#228B22",
    linewidth = 0.5,
    alpha = 0.5
  ) +
  geom_sf(
    data = shp_bnd_elem_diff,
    color = "#FFB347",
    fill = "#FFB347",
    linewidth = 0.7,
    alpha = 0.5
  ) +
  geom_sf(
    data = shp_bnd_riverside,
    color = "#9370DB",
    fill = "#9370DB",
    linewidth = 1,
    alpha = 0.5
  ) +
  coord_sf(clip = "off") +
  theme_void() + 
  theme(plot.caption = element_text(hjust = 0, face = "italic", size = 9)))
```
| District                                                       | Levy/Base                         | 2021 Rate | 2021 Tax |
|-----------------------|----------------|----------------|----------------|
| [**Village of Riverside**]{style="color:purple;"}          | $`r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(levy)`/ $`r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(base)`     | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(rate)` | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(property_tax)` |
| [**Elementary School District 96**]{style="color:orange;"} | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(levy)`/`r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(base)` | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(rate)`             | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(property_tax)` 
| [**Riverside Township**]{style="color:green;"}             |`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(levy)`/`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(base)`| `r df %>% filter(district=="TOWN RIVERSIDE") %>% select(rate)`| `r df %>% filter(district=="TOWN RIVERSIDE") %>% select(property_tax)`    |
| [**Brookfield High School District 208**]{style="color:blue;"} |`r df %>% filter(district=="RIVERSIDE BROOKFIELD HIGH SCHOOL 208") %>% select(levy)`/`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(base)`      | `r df %>% filter(district=="RIVERSIDE BROOKFIELD HIGH SCHOOL 208") %>% select(rate)`| `r df %>% filter(district=="RIVERSIDE BROOKFIELD HIGH SCHOOL 208") %>% select(property_tax)` |
| [**Des Plaines Valley Mosquito Abatement District**]{style="color:red;"}                  | `r df %>% filter(district=="DES PLAINES VALLEY MOSQUITO ABATEMENT DISTRICT") %>% select(levy)`/`r df %>% filter(district=="DES PLAINES VALLEY MOSQUITO ABATEMENT DISTRICT") %>% select(base)`| `r df %>% filter(district=="DES PLAINES VALLEY MOSQUITO ABATEMENT DISTRICT") %>% select(rate)`   | `r df %>% filter(district=="DES PLAINES VALLEY MOSQUITO ABATEMENT DISTRICT") %>% select(property_tax)`    |


---

And so on:

| District                                                       | Levy/Base                         | 2021 Rate | 2021 Tax |
|-----------------------|-----------------|-----------------|-----------------|
| [**Village of Riverside**]{style="color:purple;"}          | $`r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(levy)`/ $`r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(base)`     | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(rate)` | `r df %>% filter(district=="VILLAGE OF RIVERSIDE") %>% select(property_tax)` |
| [**Elementary School District 96**]{style="color:orange;"} | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(levy)`/`r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(base)` | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(rate)`             | `r df %>% filter(district=="SCHOOL DISTRICT 96") %>% select(property_tax)` 
| [**Riverside Township**]{style="color:green;"}             |`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(levy)`/`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(base)`| `r df %>% filter(district=="TOWN RIVERSIDE") %>% select(rate)`| `r df %>% filter(district=="TOWN RIVERSIDE") %>% select(property_tax)`    |
| [**Brookfield High School District 208**]{style="color:blue;"} |`r df %>% filter(district=="RIVERSIDE BROOKFIELD HIGH SCHOOL 208") %>% select(levy)`/`r df %>% filter(district=="TOWN RIVERSIDE") %>% select(base)`      | `r df %>% filter(district=="RIVERSIDE BROOKFIELD HIGH SCHOOL 208") %>% select(rate)`| `r df %>% filter(district=="RIVERSIDE BROOKFIELD HIGH SCHOOL 208") %>% select(property_tax)` |
| [**Des Plaines Valley Mosquito Abatement District**]{style="color:red;"}                  | `r df %>% filter(district=="DES PLAINES VALLEY MOSQUITO ABATEMENT DISTRICT") %>% select(levy)`/`r df %>% filter(district=="DES PLAINES VALLEY MOSQUITO ABATEMENT DISTRICT") %>% select(base)`| `r df %>% filter(district=="DES PLAINES VALLEY MOSQUITO ABATEMENT DISTRICT") %>% select(rate)`   | `r df %>% filter(district=="DES PLAINES VALLEY MOSQUITO ABATEMENT DISTRICT") %>% select(property_tax)`    |
| [**MSWR**]{style="color:navy;"}                                | `r df %>% filter(district=="METRO WATER RECLAMATION DISTRICT OF GREATER CHICAGO") %>% select(levy)`/`r df %>% filter(district=="METRO WATER RECLAMATION DISTRICT OF GREATER CHICAGO") %>% select(base)`| `r df %>% filter(district=="METRO WATER RECLAMATION DISTRICT OF GREATER CHICAGO") %>% select(rate)`   | `r df %>% filter(district=="METRO WATER RECLAMATION DISTRICT OF GREATER CHICAGO") %>% select(property_tax)` |
| [**Cook County**]{style="color:black;"}                        | `r df %>% filter(district=="COUNTY OF COOK") %>% select(levy)`/`r df %>% filter(district=="COUNTY OF COOK") %>% select(base)`| `r df %>% filter(district=="COUNTY OF COOK") %>% select(rate)`   | `r df %>% filter(district=="COUNTY OF COOK") %>% select(property_tax)` |

## Now let's compare this to the bill above

When reorganized, our bill matches the real bill

```{r}
single_bill <- tax_bill(year_vec = 2020, pin_vec = "15361000280000")
single_bill %>%
  select(agency_name, final_tax, agency_tax_rate) %>%
  mutate(agency_tax_rate = agency_tax_rate * 100) %>%
  arrange(-row_number()) %>%
  setNames(c("Agency", "2020 Tax", "2020 Rate")) %>%
  knitr::kable("html", digits = 3)


```

